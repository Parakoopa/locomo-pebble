<!DOCTYPE html>
<html>

<head>
    <title>Locomo Config</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <script src="http://code.jquery.com/jquery-1.12.3.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
</head>

<body>

    <div data-role="page" id="main">
        <div data-role="header" class="jqm-header">
            <h1>Locomo Config</h1>
        </div>
        <div data-role="content">
            <div data-role="fieldcontain">
                <label for="station_home">Home:</label>
                <input type='text' class='form-control' style='text-transform:uppercase' id='station_home' maxlength='3' placeholder="3-letter station code" />
            </div>

            <div data-role="fieldcontain">
                <label for="station_work">Work:</label>
                <input type='text' class='form-control' style='text-transform:uppercase' id='station_work' maxlength='3' placeholder="3-letter station code" />
            </div>

            <div class="ui-body ui-body-b">
                <fieldset class="ui-grid-a">
                    <div class="ui-block-a">
                        <button type="submit" data-theme="d" id="b-cancel">Cancel</button>
                    </div>
                    <div class="ui-block-b">
                        <button type="submit" data-theme="a" id="b-submit">Submit</button>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>

    <script>
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function updateSettings() {
            var home = getParameterByName('station_home');
            var work = getParameterByName('station_work');
            if (home) {
                $('#station_home').val(home);
            }
            if (work) {
                $('#station_work').val(work);
            }
        }

        function saveOptions() {
            var options = {
                'station_home': $("#station_home").val(),
                'station_work': $("#station_work").val(),
            }
            return options;
        }

        // Determine the correct return URL (emulator vs real watch)
        function getQueryParam(variable, defaultValue) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (pair[0] === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return defaultValue || false;
        }

        $().ready(function() {
            $("#b-cancel").click(function() {
                document.location = "pebblejs://close";
            });
            $("#b-submit").click(function() {
                var return_to = getQueryParam('return_to', 'pebblejs://close#');
                var location = return_to + encodeURIComponent(JSON.stringify(saveOptions()));
                console.log("Warping to: " + location);
                document.location = location;
            });
        });
        $('#main').bind('pageinit', updateSettings);
    </script>

</body>

</html>
