<!DOCTYPE html>
<html>

<head>
    <title>Locomo Config</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/south-street/jquery-ui.css" />
    <script src="http://code.jquery.com/jquery-1.12.3.min.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js" integrity="sha256-xNjb53/rY+WmG+4L6tTl9m6PpqknWZvRt0rO1SRnJzw=" crossorigin="anonymous"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
</head>

<body>

    <div data-role="page" id="main">
        <div data-role="header" class="jqm-header">
            <h1>Locomo Config</h1>
        </div>
        <div data-role="content">
            <div data-role="fieldcontain">
                <label for="station_home">Home:</label>
                <input type='text' class='form-control' id='station_home_label' placeholder="Search home station" />
                <input type='hidden' id='station_home' />
                <input type='hidden' id='station_home_lon' />
                <input type='hidden' id='station_home_lat' />
            </div>

            <div data-role="fieldcontain">
                <label for="station_work">Work:</label>
                <input type='text' class='form-control' id='station_work_label' placeholder="Search work station" />
                <input type='hidden' id='station_work' />
                <input type='hidden' id='station_work_lon' />
                <input type='hidden' id='station_work_lat' />
            </div>

            <div class="ui-body ui-body-b">
                <fieldset class="ui-grid-a">
                    <div class="ui-block-a">
                        <button type="submit" data-theme="d" id="b-cancel">Cancel</button>
                    </div>
                    <div class="ui-block-b">
                        <button type="submit" data-theme="a" id="b-submit">Submit</button>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>

    <script>
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function loadOptions() {
            var options = {}
                //Add all textual values
            $('textarea, select, [type="hidden"], [type="password"], [type="text"]').each(function() {
                    $(this).val(getParameterByName($(this).attr('id')));
                })
                //Add all checkbox type values
            $('[type="radio"], [type="checkbox"]').each(function() {
                $(this).is(':checked') = $(this).val(getParameterByName($(this).attr('id')));
            })
        }

        function saveOptions() {
            var options = {}
                //Add all textual values
            $('textarea, select, [type="hidden"], [type="password"], [type="text"]').each(function() {
                    options[$(this).attr('id')] = $(this).val();
                })
                //Add all checkbox type values
            $('[type="radio"], [type="checkbox"]').each(function() {
                options[$(this).attr('id')] = $(this).is(':checked');
            })
            return options;
        }

        // Determine the correct return URL (emulator vs real watch)
        function getQueryParam(variable, defaultValue) {
            var query = window.location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split('=');
                if (pair[0] === variable) {
                    return decodeURIComponent(pair[1]);
                }
            }
            return defaultValue || false;
        }

        // JSON autocomplete
        $("#station_home_label").autocomplete({
            source: function(request, response) {
                var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                $.ajax({
                    url: "https://raw.githubusercontent.com/yoziru-desu/locomo-pebble/gh-pages/stations.json",
                    dataType: "json",
                    success: function(data) {
                        response($.map(data.locations, function(v, i) {
                            var text = v.name;
                            if (text && (!request.term || matcher.test(text))) {
                                // Store value in hidden field
                                $('#station_home_lon').val(v.lon);
                                $('#station_home_lat').val(v.lat);
                                $('#station_home').val(v.crs);
                                return {
                                    label: v.name,
                                    value: v.name
                                };
                            }
                        }));
                    }
                });
            }
        });

        $("#station_work_label").autocomplete({
            source: function(request, response) {
                var matcher = new RegExp($.ui.autocomplete.escapeRegex(request.term), "i");
                $.ajax({
                    url: "https://raw.githubusercontent.com/yoziru-desu/locomo-pebble/gh-pages/stations.json",
                    dataType: "json",
                    success: function(data) {
                        response($.map(data.locations, function(v, i) {
                            var text = v.name;
                            if (text && (!request.term || matcher.test(text))) {
                                $('#station_work_lon').val(v.lon);
                                $('#station_work_lat').val(v.lat);
                                $('#station_work').val(v.crs);
                                return {
                                    label: v.name,
                                    value: v.name
                                };
                            }
                        }));
                    }
                });
            }
        });

        $().ready(function() {
            $("#b-cancel").click(function() {
                document.location = "pebblejs://close";
            });
            $("#b-submit").click(function() {
                var return_to = getQueryParam('return_to', 'pebblejs://close#');
                var location = return_to + encodeURIComponent(JSON.stringify(saveOptions()));
                console.log("Warping to: " + location);
                document.location = location;
            });
        });
        $('#main').bind('pageinit', loadOptions);
    </script>

</body>

</html>
